/// AUTO-GENERATED. Edit prisma/base.prisma or prisma/modules/*.prisma

/// Base Prisma definitions (generator + datasource)
/// This file should remain small; domain models live under prisma/modules.

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [citext()]
  schemas    = ["public", "auth", "hr", "compliance", "platform", "org"]
}

/// Authentication + invitation models with enhanced security

enum InvitationStatus {
  pending
  accepted
  expired
  declined
  revoked  // Added for security
  @@schema("auth")
}

enum SessionStatus {
  active
  inactive
  expired
  revoked  // Added for security
  @@schema("auth")
}

model Invitation {
  token            String           @id
  orgId            String           @db.Uuid
  organizationName String
  targetEmail      String           @db.Citext
  status           InvitationStatus @default(pending)
  invitedByUserId  String?          @db.Uuid
  // UK compliance fields
  onboardingData   Json             @db.JsonB
  metadata         Json?            @db.JsonB
  // Security fields
  securityContext  Json?            @db.JsonB // For audit trail
  ipAddress        String?          // For security monitoring
  userAgent        String?          // For security monitoring
  // Time-based fields
  expiresAt        DateTime?
  acceptedAt       DateTime?
  acceptedByUserId String?          @db.Uuid
  revokedAt        DateTime?        // Added for security
  revokedByUserId  String?          @db.Uuid // Added for security
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  invitedBy  User?        @relation("InvitationInvitedBy", fields: [invitedByUserId], references: [id], onDelete: SetNull)
  acceptedBy User?        @relation("InvitationAcceptedBy", fields: [acceptedByUserId], references: [id], onDelete: SetNull)
  revokedBy  User?        @relation("InvitationRevokedBy", fields: [revokedByUserId], references: [id], onDelete: SetNull)

  @@index([orgId, status])
  @@index([targetEmail])
  @@index([expiresAt]) // For cleanup jobs
  @@map("invitations")
  @@schema("auth")
}

model WaitlistEntry {
  id           String   @id @default(uuid())
  name         String
  email        String   @db.Citext
  industry     String
  // UK compliance fields
  organizationSize Json?  @db.JsonB // For service planning
  region       String?  // For regional service planning
  // Security fields
  ipAddress    String?  // For security monitoring
  userAgent    String?  // For security monitoring
  // For audit trail
  metadata     Json?    @db.JsonB
  createdAt    DateTime @default(now())

  @@index([email])
  @@map("waitlist_entries")
  @@schema("auth")
}

// UK-specific model for security monitoring
model SecurityEvent {
  id             String   @id @default(uuid()) @db.Uuid
  orgId          String?  @db.Uuid
  userId         String?  @db.Uuid
  eventType      String   // "failed_login", "account_lockout", "suspicious_activity", etc.
  severity       String   // "low", "medium", "high", "critical"
  description    String
  ipAddress      String?
  userAgent      String?
  additionalInfo Json?    @db.JsonB
  resolved       Boolean  @default(false)
  resolvedAt     DateTime?
  resolvedBy     String?  @db.Uuid
  createdAt      DateTime @default(now())

  org      Organization? @relation(fields: [orgId], references: [id], onDelete: SetNull)
  user     User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  resolver User?         @relation("SecurityEventResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)

  @@index([eventType])
  @@index([severity])
  @@index([resolved])
  @@map("security_events")
  @@schema("auth")
}

model TenantSecurityEvent {
  id                 String                  @id @default(uuid()) @db.Uuid
  orgId              String                  @db.Uuid
  userId             String?                 @db.Uuid
  eventType          String
  severity           String
  description        String
  ipAddress          String?
  userAgent          String?
  additionalInfo     Json?                   @db.JsonB
  resolved           Boolean                 @default(false)
  resolvedAt         DateTime?
  resolvedBy         String?                 @db.Uuid
  createdAt          DateTime                @default(now())
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)

  org      Organization @relation("TenantSecurityEventOrganization", fields: [orgId], references: [id], onDelete: Cascade)
  user     User?        @relation("TenantSecurityEventUser", fields: [userId], references: [id], onDelete: SetNull)
  resolver User?        @relation("TenantSecurityEventResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)

  @@index([orgId, createdAt])
  @@index([orgId, eventType])
  @@index([orgId, severity])
  @@index([orgId, resolved])
  @@index([userId])
  @@map("tenant_security_events")
  @@schema("auth")
}

model GlobalSecurityEvent {
  id             String   @id @default(uuid()) @db.Uuid
  sourceOrgId    String?  @db.Uuid
  userId         String?  @db.Uuid
  eventType      String
  severity       String
  description    String
  ipAddress      String?
  userAgent      String?
  additionalInfo Json?    @db.JsonB
  resolved       Boolean  @default(false)
  resolvedAt     DateTime?
  resolvedBy     String?  @db.Uuid
  createdAt      DateTime @default(now())

  sourceOrg Organization? @relation("GlobalSecurityEventSourceOrg", fields: [sourceOrgId], references: [id], onDelete: SetNull)
  user      User?         @relation("GlobalSecurityEventUser", fields: [userId], references: [id], onDelete: SetNull)
  resolver  User?         @relation("GlobalSecurityEventResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)

  @@index([sourceOrgId, createdAt])
  @@index([eventType])
  @@index([severity])
  @@index([resolved])
  @@map("global_security_events")
  @@schema("auth")
}

// Model for managing session information
model UserSession {
  id         String        @id @default(uuid()) @db.Uuid
  userId     String        @db.Uuid
  sessionId  String        // Better Auth session ID
  status     SessionStatus @default(active)
  ipAddress  String?
  userAgent  String?
  // For audit trail
  startedAt  DateTime      @default(now())
  expiresAt  DateTime
  lastAccess DateTime      @default(now())
  revokedAt  DateTime?
  // For security monitoring
  metadata   Json?         @db.JsonB

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("user_sessions")
  @@schema("auth")
}

// Stores verification tokens for Better Auth flows (email, MFA, domain checks)
model Verification {
  id          String   @id
  identifier  String
  value       String
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
  @@schema("auth")
}

/// Better Auth core + plugin persistence models
/// NOTE: These models map to Better Auth's expected table shapes.
/// They live in the Postgres `auth` schema to keep auth data isolated.

model AuthUser {
  id               String   @id
  name             String
  email            String   @db.Citext
  emailVerified    Boolean  @default(false)
  image            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // username plugin
  username        String? @db.Citext
  displayUsername String?

  // twoFactor plugin
  twoFactorEnabled Boolean? @default(false)

  sessions  AuthSession[]
  accounts  AuthAccount[]
  members   AuthOrgMember[]
  invitations AuthOrgInvitation[]
  twofactors TwoFactor[]

  oauthapplications OauthApplication[]
  oauthaccesstokens OauthAccessToken[]
  oauthconsents     OauthConsent[]

  @@unique([email])
  @@unique([username])
  @@map("user")
  @@schema("auth")
}

model AuthSession {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  // organization plugin (active org context)
  activeOrganizationId String?

  @@unique([token])
  @@index([userId])
  @@map("session")
  @@schema("auth")
}

model AuthAccount {
  id         String @id
  accountId  String
  providerId String
  userId     String

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@map("account")
  @@schema("auth")
}

model AuthOrganization {
  id        String   @id
  name      String
  slug      String   @db.Citext
  logo      String?
  createdAt DateTime @default(now())
  metadata  String?

  members     AuthOrgMember[]
  invitations AuthOrgInvitation[]

  @@unique([slug])
  @@map("organization")
  @@schema("auth")
}

model AuthOrgMember {
  id             String @id
  organizationId String
  userId         String
  role           String @default("member")
  createdAt      DateTime @default(now())

  organization AuthOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         AuthUser         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("member")
  @@schema("auth")
}

model AuthOrgInvitation {
  id             String   @id
  organizationId String
  email          String   @db.Citext
  role           String?
  status         String   @default("pending")
  expiresAt      DateTime
  inviterId      String

  organization AuthOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         AuthUser         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
  @@schema("auth")
}

model TwoFactor {
  id          String @id
  secret      String
  backupCodes String
  userId      String

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("twoFactor")
  @@schema("auth")
}

model OauthApplication {
  id           String  @id
  name         String?
  icon         String?
  metadata     String?
  clientId     String? @db.Citext
  clientSecret String?
  redirectURLs String?
  type         String?
  disabled     Boolean? @default(false)
  userId       String?
  createdAt    DateTime? @default(now())
  updatedAt    DateTime? @updatedAt

  user AuthUser? @relation(fields: [userId], references: [id], onDelete: Cascade)

  oauthaccesstokens OauthAccessToken[]
  oauthconsents     OauthConsent[]

  @@unique([clientId])
  @@map("oauthApplication")
  @@schema("auth")
}

model OauthAccessToken {
  id                    String  @id
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  clientId              String? @db.Citext
  userId                String?
  scopes                String?
  createdAt             DateTime? @default(now())
  updatedAt             DateTime? @updatedAt

  oauthapplication OauthApplication? @relation(fields: [clientId], references: [clientId], onDelete: Cascade)
  user             AuthUser?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([accessToken])
  @@unique([refreshToken])
  @@map("oauthAccessToken")
  @@schema("auth")
}

model OauthConsent {
  id           String  @id
  clientId     String? @db.Citext
  userId       String?
  scopes       String?
  createdAt    DateTime? @default(now())
  updatedAt    DateTime? @updatedAt
  consentGiven Boolean?

  oauthapplication OauthApplication? @relation(fields: [clientId], references: [clientId], onDelete: Cascade)
  user             AuthUser?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("oauthConsent")
  @@schema("auth")
}

// Billing and subscription models
enum BillingSubscriptionStatus {
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  PAUSED
  @@schema("hr")
}

model OrganizationSubscription {
  id                       String                    @id @default(uuid()) @db.Uuid
  orgId                    String                    @db.Uuid
  stripeCustomerId         String                    @db.Text
  stripeSubscriptionId     String                    @db.Text
  stripeSubscriptionItemId String?                   @db.Text
  stripePriceId            String                    @db.Text
  status                   BillingSubscriptionStatus @default(INCOMPLETE)
  seatCount                Int                       @default(1)
  currentPeriodEnd         DateTime?
  cancelAtPeriodEnd        Boolean                   @default(false)
  lastStripeEventAt        DateTime?
  metadata                 Json?                     @db.JsonB
  dataClassification       DataClassificationLevel   @default(OFFICIAL)
  residencyTag             DataResidencyZone         @default(UK_ONLY)
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId])
  @@unique([stripeCustomerId])
  @@unique([stripeSubscriptionId])
  @@index([orgId, status])
  @@map("organization_subscriptions")
  @@schema("hr")
}

enum PaymentMethodType {
  CARD
  BACS_DEBIT
  SEPA_DEBIT
  @@schema("hr")
}

model PaymentMethod {
  id                     String                @id @default(uuid()) @db.Uuid
  orgId                  String                @db.Uuid
  stripePaymentMethodId  String                @unique @db.Text
  type                   PaymentMethodType
  last4                  String
  brand                  String?               @db.Text
  bankName               String?               @db.Text
  expiryMonth            Int?
  expiryYear             Int?
  isDefault              Boolean               @default(false)
  metadata               Json?                 @db.JsonB
  dataClassification     DataClassificationLevel @default(OFFICIAL)
  residencyTag           DataResidencyZone       @default(UK_ONLY)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([orgId, isDefault])
  @@map("payment_methods")
  @@schema("hr")
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
  @@schema("hr")
}

model BillingInvoice {
  id                String                @id @default(uuid()) @db.Uuid
  orgId             String                @db.Uuid
  stripeInvoiceId   String                @unique @db.Text
  status            InvoiceStatus
  amountDue         Int
  amountPaid        Int
  currency          String                @default("gbp")
  periodStart       DateTime
  periodEnd         DateTime
  userCount         Int
  invoiceUrl        String?               @db.Text
  invoicePdf        String?               @db.Text
  paidAt            DateTime?
  metadata          Json?                 @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, periodStart])
  @@index([orgId, status])
  @@map("billing_invoices")
  @@schema("hr")
}

// HR notification models with tenant scoping and compliance metadata

enum HRNotificationType {
  LEAVE_APPROVAL       @map("leave-approval")
  LEAVE_REJECTION      @map("leave-rejection")
  DOCUMENT_EXPIRY      @map("document-expiry")
  POLICY_UPDATE        @map("policy-update")
  PERFORMANCE_REVIEW   @map("performance-review")
  TIME_ENTRY           @map("time-entry")
  TRAINING_ASSIGNED    @map("training-assigned")
  TRAINING_DUE         @map("training-due")
  TRAINING_COMPLETED   @map("training-completed")
  TRAINING_OVERDUE     @map("training-overdue")
  SYSTEM_ANNOUNCEMENT  @map("system-announcement")
  COMPLIANCE_REMINDER  @map("compliance-reminder")
  OTHER                @map("other")
  @@schema("hr")
}

enum NotificationPriority {
  LOW    @map("low")
  MEDIUM @map("medium")
  HIGH   @map("high")
  URGENT @map("urgent")
  @@schema("hr")
}

model HRNotification {
  id               String                 @id @default(uuid()) @db.Uuid
  orgId            String                 @db.Uuid
  userId           String                 @db.Uuid
  title            String
  message          String
  type             HRNotificationType     @default(OTHER)
  priority         NotificationPriority   @default(MEDIUM)
  isRead           Boolean                @default(false)
  readAt           DateTime?
  actionUrl        String?
  actionLabel      String?
  scheduledFor     DateTime?
  expiresAt        DateTime?
  correlationId    String?
  createdByUserId  String?                @db.Uuid
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  metadata         Json?                  @db.JsonB
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  membership Membership   @relation(fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)

  @@index([orgId, userId, isRead])
  @@index([orgId, userId, type])
  @@index([orgId, scheduledFor])
  @@index([orgId, priority, createdAt])
  @@map("notifications")
  @@schema("hr")
}

// HR domain models with UK employment law compliance

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  INTERN
  APPRENTICE
  FIXED_TERM
  CASUAL
  @@schema("hr")
}

enum LeavePolicyType {
  ANNUAL
  SICK
  MATERNITY
  PATERNITY
  ADOPTION
  UNPAID
  SPECIAL
  EMERGENCY
  @@schema("hr")
}

enum LeaveAccrualFrequency {
  MONTHLY
  QUARTERLY
  YEARLY
  NONE
  @@schema("hr")
}

enum LeaveRequestStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
  PENDING_APPROVAL
  AWAITING_MANAGER
  @@schema("hr")
}

enum HealthStatus {
  UNDEFINED
  FIT_FOR_WORK
  PARTIALLY_FIT
  UNFIT_FOR_WORK
  RECOVERY_PLAN
  @@schema("hr")
}

enum EmploymentStatus {
  ACTIVE
  INACTIVE
  TERMINATED
  ON_LEAVE
  OFFBOARDING
  ARCHIVED
  @@schema("hr")
}

enum SalaryFrequency {
  HOURLY
  MONTHLY
  ANNUALLY
  @@schema("hr")
}

enum SalaryBasis {
  ANNUAL
  HOURLY
  @@schema("hr")
}

enum PaySchedule {
  MONTHLY
  BI_WEEKLY
  @@schema("hr")
}

enum ContractType {
  PERMANENT
  FIXED_TERM
  AGENCY
  CONSULTANT
  INTERNSHIP
  APPRENTICESHIP
  @@schema("hr")
}

enum PerformanceGoalStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  @@schema("hr")
}

model EmployeeProfile {
  id               String           @id @default(uuid()) @db.Uuid
  orgId            String           @db.Uuid
  userId           String           @db.Uuid
  firstName        String?
  lastName         String?
  displayName      String?
  photoUrl         String?
  email            String?          @db.Citext
  personalEmail    String?          @db.Citext
  employeeNumber   String
  jobTitle         String?
  departmentId     String?          @db.Uuid
  employmentType   EmploymentType   @default(FULL_TIME)
  employmentStatus EmploymentStatus @default(ACTIVE)
  startDate        DateTime?
  endDate          DateTime?
  managerOrgId     String?          @db.Uuid
  managerUserId    String?          @db.Uuid
  phone            Json?            @db.JsonB
  address          Json?            @db.JsonB
  annualSalary     Int?
  hourlyRate       Decimal?         @db.Decimal(8, 2) // For part-time/contract workers
  salaryAmount     Decimal?         @db.Decimal(12, 2)
  salaryCurrency   String?
  salaryFrequency  SalaryFrequency?
  salaryBasis      SalaryBasis?
  paySchedule      PaySchedule?
  costCenter       String?
  location         Json?            @db.JsonB
  roles            String[]         @db.Text
  eligibleLeaveTypes String[]       @db.Text
  employmentPeriods Json?           @db.JsonB
  salaryDetails    Json?            @db.JsonB
  skills           String[]         @db.Text
  certifications   Json?            @db.JsonB
  // UK-specific fields
  niNumber         String?          @db.Text // National Insurance number (encrypted at app layer)
  emergencyContact Json?            @db.JsonB
  nextOfKin        Json?            @db.JsonB
  healthStatus     HealthStatus     @default(UNDEFINED)
  workPermit       Json?            @db.JsonB // For visa/immigration compliance
  bankDetails      Json?            @db.JsonB // Encrypted at application layer
  metadata         Json?            @db.JsonB
  // Compliance, audit, retention
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource      String?
  correlationId    String?
  schemaVersion    Int              @default(1)
  createdBy        String?          @db.Uuid
  updatedBy        String?          @db.Uuid
  retentionPolicy  RetentionPolicy?
  retentionExpiresAt DateTime?
  erasureRequestedAt DateTime?
  erasureCompletedAt DateTime?
  erasureReason    String?
  erasureActorOrgId String?         @db.Uuid
  erasureActorUserId String?        @db.Uuid
  archivedAt       DateTime?
  deletedAt        DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  membership    Membership        @relation(fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)
  manager       EmployeeProfile?  @relation("EmployeeManager", fields: [managerOrgId, managerUserId], references: [orgId, userId])
  reports       EmployeeProfile[] @relation("EmployeeManager")
  leaveBalances LeaveBalance[]    @relation("ProfileLeaveBalances")
  checklistInstances ChecklistInstance[] @relation("EmployeeChecklistInstances")
  offboardingRecords Offboarding[]
  mentorAssignments MentorAssignment[]
  provisioningTasks ProvisioningTask[]
  onboardingWorkflowRuns OnboardingWorkflowRun[]
  emailSequenceEnrollments EmailSequenceEnrollment[]
  onboardingMetricResults OnboardingMetricResult[]
  onboardingFeedback OnboardingFeedback[]
  documentTemplateAssignments DocumentTemplateAssignment[]
  department    Department?       @relation("DepartmentProfiles", fields: [departmentId], references: [id], onDelete: SetNull)

  @@unique([orgId, userId])
  @@unique([orgId, employeeNumber])
  @@index([orgId, email])
  @@index([managerOrgId, managerUserId])
  @@index([orgId, employmentStatus])
  @@index([orgId, dataClassification, residencyTag])
  @@index([departmentId])
  @@map("employee_profiles")
  @@schema("hr")
}

model EmploymentContract {
  id               String        @id @default(uuid()) @db.Uuid
  orgId            String        @db.Uuid
  userId           String        @db.Uuid
  contractType     ContractType  @default(PERMANENT)
  startDate        DateTime
  endDate          DateTime?
  jobTitle         String
  departmentId     String?       @db.Uuid
  location         String?
  probationEndDate DateTime?
  // UK-specific fields
  furloughStartDate DateTime?    // For UK furlough schemes
  furloughEndDate   DateTime?
  workingPattern    Json?        @db.JsonB // Hours, flexible work arrangements
  benefits          Json?        @db.JsonB
  terminationReason String?
  terminationNotes  String?
  archivedAt        DateTime?
  deletedAt        DateTime?
  // Compliance, audit, retention
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource      String?
  correlationId    String?
  schemaVersion    Int              @default(1)
  createdBy        String?          @db.Uuid
  updatedBy        String?          @db.Uuid
  retentionPolicy  RetentionPolicy?
  retentionExpiresAt DateTime?
  erasureRequestedAt DateTime?
  erasureCompletedAt DateTime?
  erasureReason    String?
  erasureActorOrgId String?         @db.Uuid
  erasureActorUserId String?        @db.Uuid
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  membership  Membership     @relation(fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)
  department  Department?    @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  @@index([orgId, userId])
  @@index([orgId, dataClassification, residencyTag])
  @@map("employment_contracts")
  @@schema("hr")
}

model LeavePolicy {
  id               String                @id @default(uuid()) @db.Uuid
  orgId            String                @db.Uuid
  departmentId     String?               @db.Uuid
  name             String
  policyType       LeavePolicyType
  accrualFrequency LeaveAccrualFrequency @default(NONE)
  accrualAmount    Decimal?              @db.Decimal(5, 2)
  carryOverLimit   Int?
  requiresApproval Boolean               @default(true)
  isDefault        Boolean               @default(false)
  activeFrom       DateTime              @default(now())
  activeTo         DateTime?
  // UK-specific compliance fields
  statutoryCompliance Boolean             @default(false) // For statutory leave (sick, maternity, etc.)
  maxConsecutiveDays Int?                 // For policy enforcement
  allowNegativeBalance Boolean           @default(false) // For emergency leave
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource      String?
  auditBatchId     String?
  metadata         Json?                 @db.JsonB

  org          Organization         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  department   Department?          @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  accrualRules LeavePolicyAccrual[]
  balances     LeaveBalance[]
  requests     LeaveRequest[]

  @@unique([orgId, name])
  @@index([orgId, dataClassification, residencyTag])
  @@map("leave_policies")
  @@schema("hr")
}

model LeavePolicyAccrual {
  id               String  @id @default(uuid()) @db.Uuid
  policyId         String  @db.Uuid
  tenureMonths     Int     @default(0)
  accrualPerPeriod Decimal @db.Decimal(5, 2)
  carryOverLimit   Int?

  policy LeavePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([policyId, tenureMonths])
  @@map("leave_policy_accruals")
  @@schema("hr")
}

model LeaveBalance {
  id           String   @id @default(uuid()) @db.Uuid
  orgId        String   @db.Uuid
  userId       String   @db.Uuid
  policyId     String   @db.Uuid
  periodStart  DateTime
  periodEnd    DateTime
  accruedHours Decimal  @db.Decimal(6, 2) @default(0)
  usedHours    Decimal  @db.Decimal(6, 2) @default(0)
  carriedHours Decimal  @db.Decimal(6, 2) @default(0)
  // For UK compliance tracking
  approvedAt   DateTime? // When the balance was last approved
  approvedBy   String?   @db.Uuid
  // For audit trail
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource      String?
  auditBatchId     String?
  metadata     Json?    @db.JsonB
  updatedAt    DateTime @updatedAt

  membership Membership      @relation("MembershipLeaveBalances", fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade, map: "leave_balance_membership_fk")
  profile    EmployeeProfile @relation("ProfileLeaveBalances", fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade, map: "leave_balance_profile_fk")
  policy     LeavePolicy     @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId, policyId, periodStart])
  @@index([policyId])
  @@index([orgId, dataClassification, residencyTag])
  @@map("leave_balances")
  @@schema("hr")
}

model LeaveRequest {
  id             String             @id @default(uuid()) @db.Uuid
  orgId          String             @db.Uuid
  userId         String             @db.Uuid
  policyId       String             @db.Uuid
  status         LeaveRequestStatus @default(DRAFT)
  startDate      DateTime
  endDate        DateTime
  hours          Decimal            @db.Decimal(6, 2)
  reason         String?
  approverOrgId  String?            @db.Uuid
  approverUserId String?            @db.Uuid
  submittedAt    DateTime?
  decidedAt      DateTime?
  // UK-specific fields
  approvedByLineManager Boolean @default(false) // For statutory requirements
  sickNoteRequired  Boolean   @default(false) // For sick leave
  sickNoteReceived  Boolean   @default(false)
  returnToWorkDate  DateTime? // For health monitoring
  // For audit trail
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource      String?
  auditBatchId     String?
  metadata       Json?              @db.JsonB
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  membership Membership  @relation(fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)
  policy     LeavePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  approver   Membership? @relation("LeaveApprover", fields: [approverOrgId, approverUserId], references: [orgId, userId], onDelete: SetNull)
  attachments LeaveAttachment[]

  @@index([orgId, status])
  @@index([policyId])
  @@index([orgId, dataClassification, residencyTag])
  @@map("leave_requests")
  @@schema("hr")
}

model LeaveAttachment {
  id               String                 @id @default(uuid()) @db.Uuid
  orgId            String                 @db.Uuid
  requestId        String                 @db.Uuid
  fileName         String
  storageKey       String
  contentType      String
  fileSize         Int
  checksum         String?
  uploadedByUserId String                 @db.Uuid
  uploadedAt       DateTime               @default(now())
  metadata         Json?                  @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource      String?
  auditBatchId     String?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  request LeaveRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([orgId, requestId])
  @@index([orgId, dataClassification, residencyTag])
  @@map("leave_attachments")
  @@schema("hr")
}

// UK-specific performance and appraisal model
model PerformanceReview {
  id               String   @id @default(uuid()) @db.Uuid
  orgId            String   @db.Uuid
  userId           String   @db.Uuid
  reviewerOrgId    String   @db.Uuid
  reviewerUserId   String   @db.Uuid
  periodStartDate  DateTime
  periodEndDate    DateTime
  scheduledDate    DateTime
  completedDate    DateTime?
  status           String   @default("scheduled")
  overallRating    Int?     // 1-5 scale
  strengths        String?
  areasForImprovement String?
  developmentPlan  Json?    @db.JsonB
  reviewerNotes    String?
  employeeResponse String?
  metadata         Json?    @db.JsonB
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  goals PerformanceGoal[]

  reviewedMembership   Membership @relation("RevieweeMembership", fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)
  reviewerMembership   Membership @relation("ReviewerMembership", fields: [reviewerOrgId, reviewerUserId], references: [orgId, userId], onDelete: Cascade)

  @@index([orgId, userId])
  @@index([periodStartDate])
  @@index([periodEndDate])
  @@map("performance_reviews")
  @@schema("hr")
}

model PerformanceGoal {
  id          String                @id @default(uuid()) @db.Uuid
  orgId       String                @db.Uuid
  reviewId    String                @db.Uuid
  description String
  targetDate  DateTime
  status      PerformanceGoalStatus @default(PENDING)
  rating      Int?
  comments    String?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  review PerformanceReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([orgId, status, targetDate])
  @@index([reviewId])
  @@map("performance_goals")
  @@schema("hr")
}

// UK-specific training and development model
model TrainingRecord {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @db.Uuid
  userId        String   @db.Uuid
  courseName    String
  provider      String
  startDate     DateTime
  endDate       DateTime?
  expiryDate    DateTime?
  renewalDate   DateTime?
  status        String   @default("in_progress")
  certificate   String?  // Path to certificate document
  competency    Json?    @db.JsonB // Skills gained
  cost          Decimal? @db.Decimal(10, 2)
  approved      Boolean  @default(false)
  approvedAt    DateTime?
  approvedBy    String?  @db.Uuid
  metadata      Json?    @db.JsonB
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  membership    Membership @relation(fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)

  @@index([orgId, userId])
  @@map("training_records")
  @@schema("hr")
}

// HR operational models: absences, time tracking, policies, settings, compliance

enum AbsenceStatus {
  REPORTED
  APPROVED
  REJECTED
  CANCELLED
  CLOSED
  @@schema("hr")
}

enum TimeEntryStatus {
  ACTIVE
  COMPLETED
  APPROVED
  REJECTED
  @@schema("hr")
}

enum PolicyCategory {
  HR_POLICIES
  CODE_OF_CONDUCT
  HEALTH_SAFETY
  IT_SECURITY
  BENEFITS
  PROCEDURES
  COMPLIANCE
  OTHER
  @@schema("hr")
}

enum ChecklistTemplateType {
  onboarding
  offboarding
  custom
  @@schema("hr")
}

enum ChecklistInstanceStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
  @@schema("hr")
}

enum OffboardingStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
  @@schema("hr")
}

enum MentorAssignmentStatus {
  ACTIVE
  ENDED
  @@schema("hr")
}

enum ProvisioningTaskType {
  ACCOUNT
  EQUIPMENT
  ACCESS
  LICENSE
  SOFTWARE
  @@schema("hr")
}

enum ProvisioningTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
  @@schema("hr")
}

enum WorkflowTemplateType {
  ONBOARDING
  OFFBOARDING
  @@schema("hr")
}

enum WorkflowRunStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
  @@schema("hr")
}

enum EmailSequenceTrigger {
  ONBOARDING_INVITE
  ONBOARDING_ACCEPTED
  OFFBOARDING_STARTED
  @@schema("hr")
}

enum EmailSequenceStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
  @@schema("hr")
}

enum EmailSequenceDeliveryStatus {
  QUEUED
  SENT
  FAILED
  SKIPPED
  @@schema("hr")
}

enum OnboardingMetricSource {
  SYSTEM
  SURVEY
  MANUAL
  @@schema("hr")
}

enum DocumentAssignmentStatus {
  PENDING
  COMPLETED
  WAIVED
  @@schema("hr")
}

enum ComplianceItemStatus {
  PENDING
  COMPLETE
  MISSING
  PENDING_REVIEW
  NOT_APPLICABLE
  EXPIRED
  @@schema("hr")
}

model AbsenceTypeConfig {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @db.Uuid
  key           String
  label         String
  tracksBalance Boolean  @default(false)
  isActive      Boolean  @default(true)
  metadata      Json?    @db.JsonB
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  org       Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  absences  UnplannedAbsence[]

  @@unique([orgId, key])
  @@map("absence_type_configs")
  @@schema("hr")
}

model AbsenceSettings {
  orgId          String   @id @db.Uuid
  hoursInWorkDay Decimal  @db.Decimal(5, 2) @default(8)
  roundingRule   String?
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("absence_settings")
  @@schema("hr")
}

model HRSettings {
  orgId             String   @id @db.Uuid
  leaveTypes        Json?    @db.JsonB // Array of { type, displayName, entitlement, maxCarryOver, requiresApproval, autoApprovalThreshold }
  workingHours      Json?    @db.JsonB // { standardHoursPerDay, standardDaysPerWeek, overtimeThreshold }
  approvalWorkflows Json?    @db.JsonB // { leaveRequests: {...}, documents: {...}, policies: {...} }
  overtimePolicy    Json?    @db.JsonB // { enableOvertime, roundingRule, approvalRequired }
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  metadata          Json?    @db.JsonB
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("hr_settings")
  @@schema("hr")
}

model UnplannedAbsence {
  id             String         @id @default(uuid()) @db.Uuid
  orgId          String         @db.Uuid
  userId         String         @db.Uuid
  typeId         String         @db.Uuid
  startDate      DateTime
  endDate        DateTime
  hours          Decimal        @db.Decimal(6, 2)
  reason         String?
  status         AbsenceStatus  @default(REPORTED)
  healthStatus   HealthStatus?
  approverOrgId  String?        @db.Uuid
  approverUserId String?        @db.Uuid
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  metadata       Json?          @db.JsonB
  deletionReason String?
  deletedAt      DateTime?
  deletedByUserId String?       @db.Uuid
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  org      Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  member   Membership        @relation("MemberAbsences", fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)
  type     AbsenceTypeConfig @relation(fields: [typeId], references: [id], onDelete: Restrict)
  approver Membership?       @relation("AbsenceApprover", fields: [approverOrgId, approverUserId], references: [orgId, userId], onDelete: SetNull)
  attachments   AbsenceAttachment[]
  returnRecord  AbsenceReturnRecord?
  deletionAudit AbsenceDeletionAudit?

  @@index([orgId, userId])
  @@index([orgId, status])
  @@map("unplanned_absences")
  @@schema("hr")
}

model AbsenceAttachment {
  id               String                 @id @default(uuid()) @db.Uuid
  orgId            String                 @db.Uuid
  absenceId        String                 @db.Uuid
  fileName         String
  storageKey       String
  contentType      String
  fileSize         Int
  checksum         String?
  uploadedByUserId String                 @db.Uuid
  uploadedAt       DateTime               @default(now())
  metadata         Json?                  @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)

  absence  UnplannedAbsence @relation(fields: [absenceId], references: [id], onDelete: Cascade)
  @@index([orgId, absenceId])
  @@map("unplanned_absence_attachments")
  @@schema("hr")
}

model AbsenceReturnRecord {
  id                String                 @id @default(uuid()) @db.Uuid
  orgId             String                 @db.Uuid
  absenceId         String                 @db.Uuid @unique
  returnDate        DateTime
  comments          String?
  submittedByUserId String                 @db.Uuid
  submittedAt       DateTime               @default(now())
  metadata          Json?                  @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)

  absence  UnplannedAbsence @relation(fields: [absenceId], references: [id], onDelete: Cascade)
  @@index([orgId])
  @@map("unplanned_absence_returns")
  @@schema("hr")
}

model AbsenceDeletionAudit {
  id               String                 @id @default(uuid()) @db.Uuid
  orgId            String                 @db.Uuid
  absenceId        String                 @db.Uuid @unique
  reason           String
  deletedByUserId  String                 @db.Uuid
  deletedAt        DateTime               @default(now())
  metadata         Json?                  @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)

  absence   UnplannedAbsence @relation(fields: [absenceId], references: [id], onDelete: Cascade)
  @@index([orgId])
  @@map("unplanned_absence_deletions")
  @@schema("hr")
}

model TimeEntry {
  id               String          @id @default(uuid()) @db.Uuid
  orgId            String          @db.Uuid
  userId           String          @db.Uuid
  date             DateTime
  clockIn          DateTime
  clockOut         DateTime?
  totalHours       Decimal?        @db.Decimal(6, 2)
  breakDuration    Decimal?        @db.Decimal(5, 2)
  project          String?
  tasks            Json?           @db.JsonB
  notes            String?
  status           TimeEntryStatus @default(ACTIVE)
  approvedByOrgId  String?         @db.Uuid
  approvedByUserId String?         @db.Uuid
  approvedAt       DateTime?
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  metadata         Json?           @db.JsonB
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  org        Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  membership Membership      @relation("MemberTimeEntries", fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)
  approver   Membership?     @relation("TimeEntryApprover", fields: [approvedByOrgId, approvedByUserId], references: [orgId, userId], onDelete: SetNull)

  @@index([orgId, userId])
  @@index([orgId, status])
  @@map("time_entries")
  @@schema("hr")
}

model HRPolicy {
  id                     String          @id @default(uuid()) @db.Uuid
  orgId                  String          @db.Uuid
  title                  String
  content                String
  category               PolicyCategory  @default(HR_POLICIES)
  version                String          @default("v1")
  effectiveDate          DateTime
  expiryDate             DateTime?
  applicableRoles        Json?           @db.JsonB
  applicableDepartments  Json?           @db.JsonB
  requiresAcknowledgment Boolean         @default(false)
  status                 String          @default("draft")
  dataClassification     DataClassificationLevel @default(OFFICIAL)
  residencyTag           DataResidencyZone       @default(UK_ONLY)
  metadata               Json?           @db.JsonB
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  org             Organization          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  acknowledgments PolicyAcknowledgment[]

  @@index([orgId, status])
  @@map("policies")
  @@schema("hr")
}

model PolicyAcknowledgment {
  id             String   @id @default(uuid()) @db.Uuid
  orgId          String   @db.Uuid
  userId         String   @db.Uuid
  policyId       String   @db.Uuid
  version        String
  acknowledgedAt DateTime @default(now())
  ipAddress      String?
  metadata       Json?    @db.JsonB

  policy     HRPolicy    @relation(fields: [policyId], references: [id], onDelete: Cascade)
  membership Membership  @relation(fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)

  @@unique([policyId, orgId, userId, version])
  @@map("policy_acknowledgments")
  @@schema("hr")
}

model ChecklistTemplate {
  id        String                @id @default(uuid()) @db.Uuid
  orgId     String                @db.Uuid
  name      String
  type      ChecklistTemplateType @default(onboarding)
  items     Json                  @db.JsonB
  metadata  Json?                 @db.JsonB
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  org Organization @relation("OrgChecklistTemplates", fields: [orgId], references: [id], onDelete: Cascade)
  instances ChecklistInstance[] @relation("ChecklistTemplateInstances")

  @@index([orgId, type])
  @@map("checklist_templates")
  @@schema("hr")
}

model ChecklistInstance {
  id           String                   @id @default(uuid()) @db.Uuid
  orgId        String                   @db.Uuid
  employeeId   String                   @db.Uuid
  templateId   String                   @db.Uuid
  templateName String?
  status       ChecklistInstanceStatus  @default(IN_PROGRESS)
  items        Json                     @db.JsonB
  startedAt    DateTime                 @default(now())
  completedAt  DateTime?
  metadata     Json?                    @db.JsonB
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt

  org        Organization       @relation("OrgChecklistInstances", fields: [orgId], references: [id], onDelete: Cascade)
  template   ChecklistTemplate  @relation("ChecklistTemplateInstances", fields: [templateId], references: [id], onDelete: Cascade)
  employee   EmployeeProfile    @relation("EmployeeChecklistInstances", fields: [employeeId], references: [id], onDelete: Cascade)
  offboarding Offboarding?      @relation("OffboardingChecklistInstance")

  @@index([orgId, employeeId])
  @@index([templateId])
  @@map("checklist_instances")
  @@schema("hr")
}

model Offboarding {
  id             String             @id @default(uuid()) @db.Uuid
  orgId          String             @db.Uuid
  employeeId     String             @db.Uuid
  initiatedByUserId String          @db.Uuid
  checklistInstanceId String?       @unique @db.Uuid
  reason         String
  status         OffboardingStatus  @default(IN_PROGRESS)
  startedAt      DateTime           @default(now())
  completedAt    DateTime?
  canceledAt     DateTime?
  metadata       Json?              @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource     String?
  correlationId   String?
  createdBy       String?           @db.Uuid
  updatedBy       String?           @db.Uuid
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  org       Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  employee  EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  checklistInstance ChecklistInstance? @relation("OffboardingChecklistInstance", fields: [checklistInstanceId], references: [id], onDelete: SetNull)
  provisioningTasks ProvisioningTask[]
  workflowRuns      OnboardingWorkflowRun[]

  @@index([orgId, employeeId])
  @@index([orgId, status])
  @@map("offboarding_records")
  @@schema("hr")
}

model MentorAssignment {
  id                String                 @id @default(uuid()) @db.Uuid
  orgId             String                 @db.Uuid
  employeeId        String                 @db.Uuid
  mentorOrgId       String                 @db.Uuid
  mentorUserId      String                 @db.Uuid
  status            MentorAssignmentStatus @default(ACTIVE)
  assignedAt        DateTime               @default(now())
  endedAt           DateTime?
  reason            String?
  metadata          Json?                  @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag        DataResidencyZone       @default(UK_ONLY)
  auditSource        String?
  correlationId      String?
  createdBy         String?                @db.Uuid
  updatedBy         String?                @db.Uuid
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  org      Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  employee EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  mentor   Membership     @relation("MentorAssignmentMentor", fields: [mentorOrgId, mentorUserId], references: [orgId, userId], onDelete: Cascade)

  @@index([orgId, employeeId])
  @@index([mentorOrgId, mentorUserId])
  @@map("mentor_assignments")
  @@schema("hr")
}

model ProvisioningTask {
  id                 String                 @id @default(uuid()) @db.Uuid
  orgId              String                 @db.Uuid
  employeeId         String                 @db.Uuid
  requestedByUserId  String                 @db.Uuid
  offboardingId      String?                @db.Uuid
  taskType           ProvisioningTaskType
  status             ProvisioningTaskStatus @default(PENDING)
  systemKey          String?
  accountIdentifier  String?
  assetTag           String?
  accessLevel        String?
  instructions       String?
  dueAt              DateTime?
  completedAt        DateTime?
  errorMessage       String?
  metadata           Json?                  @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource        String?
  correlationId      String?
  createdBy          String?                @db.Uuid
  updatedBy          String?                @db.Uuid
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt

  org        Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  requester  Membership     @relation("ProvisioningRequester", fields: [orgId, requestedByUserId], references: [orgId, userId], onDelete: Cascade)
  offboarding Offboarding?  @relation(fields: [offboardingId], references: [id], onDelete: SetNull)

  @@index([orgId, employeeId])
  @@index([orgId, status])
  @@index([offboardingId])
  @@map("provisioning_tasks")
  @@schema("hr")
}

model OnboardingWorkflowTemplate {
  id                 String               @id @default(uuid()) @db.Uuid
  orgId              String               @db.Uuid
  name               String
  description        String?
  templateType       WorkflowTemplateType @default(ONBOARDING)
  version            Int                  @default(1)
  isActive           Boolean              @default(true)
  definition         Json                 @db.JsonB
  metadata           Json?                @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource        String?
  correlationId      String?
  createdBy          String?              @db.Uuid
  updatedBy          String?              @db.Uuid
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  org   Organization            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  runs  OnboardingWorkflowRun[]

  @@index([orgId, templateType, isActive])
  @@map("onboarding_workflow_templates")
  @@schema("hr")
}

model OnboardingWorkflowRun {
  id                 String             @id @default(uuid()) @db.Uuid
  orgId              String             @db.Uuid
  employeeId         String             @db.Uuid
  templateId         String             @db.Uuid
  offboardingId      String?            @db.Uuid
  status             WorkflowRunStatus  @default(IN_PROGRESS)
  currentStepKey     String?
  startedAt          DateTime           @default(now())
  completedAt        DateTime?
  canceledAt         DateTime?
  metadata           Json?              @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource        String?
  correlationId      String?
  createdBy          String?            @db.Uuid
  updatedBy          String?            @db.Uuid
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  org        Organization            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  employee   EmployeeProfile         @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  template   OnboardingWorkflowTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  offboarding Offboarding?           @relation(fields: [offboardingId], references: [id], onDelete: SetNull)

  @@index([orgId, employeeId])
  @@index([templateId])
  @@index([offboardingId])
  @@map("onboarding_workflow_runs")
  @@schema("hr")
}

model EmailSequenceTemplate {
  id                 String              @id @default(uuid()) @db.Uuid
  orgId              String              @db.Uuid
  name               String
  description        String?
  trigger            EmailSequenceTrigger
  isActive           Boolean             @default(true)
  steps              Json                @db.JsonB
  metadata           Json?               @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource        String?
  correlationId      String?
  createdBy          String?             @db.Uuid
  updatedBy          String?             @db.Uuid
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  org         Organization             @relation(fields: [orgId], references: [id], onDelete: Cascade)
  enrollments EmailSequenceEnrollment[]

  @@index([orgId, trigger, isActive])
  @@map("email_sequence_templates")
  @@schema("hr")
}

model EmailSequenceEnrollment {
  id                 String              @id @default(uuid()) @db.Uuid
  orgId              String              @db.Uuid
  templateId         String              @db.Uuid
  employeeId         String?             @db.Uuid
  invitationToken    String?
  targetEmail        String              @db.Citext
  status             EmailSequenceStatus @default(ACTIVE)
  startedAt          DateTime            @default(now())
  pausedAt           DateTime?
  completedAt        DateTime?
  metadata           Json?               @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource        String?
  correlationId      String?
  createdBy          String?             @db.Uuid
  updatedBy          String?             @db.Uuid
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  org        Organization         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  template   EmailSequenceTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  employee   EmployeeProfile?     @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  deliveries EmailSequenceDelivery[]

  @@index([orgId, employeeId])
  @@index([templateId])
  @@index([orgId, status])
  @@map("email_sequence_enrollments")
  @@schema("hr")
}

model EmailSequenceDelivery {
  id                 String                    @id @default(uuid()) @db.Uuid
  orgId              String                    @db.Uuid
  enrollmentId       String                    @db.Uuid
  stepKey            String
  scheduledAt        DateTime
  sentAt             DateTime?
  status             EmailSequenceDeliveryStatus @default(QUEUED)
  provider           String?
  errorMessage       String?
  metadata           Json?                     @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource        String?
  correlationId      String?
  createdBy          String?                   @db.Uuid
  updatedBy          String?                   @db.Uuid
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt

  org        Organization             @relation(fields: [orgId], references: [id], onDelete: Cascade)
  enrollment EmailSequenceEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([orgId, status, scheduledAt])
  @@index([enrollmentId])
  @@map("email_sequence_deliveries")
  @@schema("hr")
}

model OnboardingMetricDefinition {
  id                 String               @id @default(uuid()) @db.Uuid
  orgId              String               @db.Uuid
  key                String
  label              String
  unit               String?
  targetValue        Decimal?             @db.Decimal(12, 2)
  thresholds         Json?                @db.JsonB
  isActive           Boolean              @default(true)
  metadata           Json?                @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource        String?
  correlationId      String?
  createdBy          String?              @db.Uuid
  updatedBy          String?              @db.Uuid
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  org     Organization              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  results OnboardingMetricResult[]

  @@unique([orgId, key])
  @@index([orgId, isActive])
  @@map("onboarding_metric_definitions")
  @@schema("hr")
}

model OnboardingMetricResult {
  id                 String                @id @default(uuid()) @db.Uuid
  orgId              String                @db.Uuid
  employeeId         String                @db.Uuid
  metricId           String                @db.Uuid
  value              Decimal?              @db.Decimal(12, 2)
  valueText          String?
  source             OnboardingMetricSource @default(SYSTEM)
  measuredAt         DateTime              @default(now())
  metadata           Json?                 @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource        String?
  correlationId      String?
  createdBy          String?               @db.Uuid
  updatedBy          String?               @db.Uuid
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt

  org      Organization            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  employee EmployeeProfile         @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  metric   OnboardingMetricDefinition @relation(fields: [metricId], references: [id], onDelete: Cascade)

  @@index([orgId, employeeId])
  @@index([metricId])
  @@map("onboarding_metric_results")
  @@schema("hr")
}

model OnboardingFeedback {
  id                 String   @id @default(uuid()) @db.Uuid
  orgId              String   @db.Uuid
  employeeId         String   @db.Uuid
  rating             Int
  summary            String?
  comments           String?
  submittedAt        DateTime @default(now())
  metadata           Json?    @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource        String?
  correlationId      String?
  createdBy          String?  @db.Uuid
  updatedBy          String?  @db.Uuid
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  org      Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  employee EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([orgId, employeeId])
  @@map("onboarding_feedback")
  @@schema("hr")
}

model DocumentTemplateAssignment {
  id                 String   @id @default(uuid()) @db.Uuid
  orgId              String   @db.Uuid
  employeeId         String   @db.Uuid
  templateId         String   @db.Uuid
  documentId         String?  @db.Uuid
  status             DocumentAssignmentStatus @default(PENDING)
  assignedAt         DateTime @default(now())
  completedAt        DateTime?
  signatureProvider  String?
  externalEnvelopeId String?
  metadata           Json?    @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource        String?
  correlationId      String?
  createdBy          String?  @db.Uuid
  updatedBy          String?  @db.Uuid
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  org      Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  employee EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  template DocumentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  document DocumentVault?   @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@index([orgId, employeeId])
  @@index([templateId])
  @@index([documentId])
  @@map("document_template_assignments")
  @@schema("hr")
}

model ComplianceTemplate {
  id          String   @id @default(uuid()) @db.Uuid
  orgId       String   @db.Uuid
  name        String
  categoryKey String?
  version     String?
  items       Json     @db.JsonB
  metadata    Json?    @db.JsonB
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  org Organization @relation("OrgComplianceTemplates", fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, categoryKey])
  @@map("compliance_templates")
  @@schema("hr")
}

model ComplianceReminderSettings {
  orgId               String                   @id @db.Uuid
  windowDays          Int                      @default(30)
  escalationDays      Int[]                    @default([])
  notifyOnComplete    Boolean                  @default(false)
  dataClassification  DataClassificationLevel  @default(OFFICIAL)
  residencyTag        DataResidencyZone        @default(UK_ONLY)
  metadata            Json?                    @db.JsonB
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("compliance_reminder_settings")
  @@schema("hr")
}

model ComplianceCategory {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @db.Uuid
  key       String
  label     String
  sortOrder Int      @default(100)
  metadata  Json?    @db.JsonB
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org Organization @relation("OrgComplianceCategories", fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, key])
  @@index([orgId, sortOrder])
  @@map("compliance_categories")
  @@schema("hr")
}

model ComplianceLogItem {
  id            String                @id @default(uuid()) @db.Uuid
  orgId         String                @db.Uuid
  userId        String                @db.Uuid
  templateItemId String
  categoryKey   String?
  status        ComplianceItemStatus  @default(PENDING)
  dueDate       DateTime?
  completedAt   DateTime?
  reviewedBy    String?
  reviewedAt    DateTime?
  notes         String?
  attachments   Json?                 @db.JsonB
  metadata      Json?                 @db.JsonB
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  org        Organization @relation("OrgComplianceLogItems", fields: [orgId], references: [id], onDelete: Cascade)
  membership Membership   @relation("MembershipComplianceLogItems", fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)

  @@index([orgId, userId])
  @@index([status, dueDate])
  @@map("compliance_log_items")
  @@schema("hr")
}

// Notification center models with compliance metadata and retention controls

enum NotificationTopic {
  LEAVE_APPROVAL       @map("leave-approval")
  LEAVE_REJECTION      @map("leave-rejection")
  DOCUMENT_EXPIRY      @map("document-expiry")
  POLICY_UPDATE        @map("policy-update")
  PERFORMANCE_REVIEW   @map("performance-review")
  SYSTEM_ANNOUNCEMENT  @map("system-announcement")
  COMPLIANCE_REMINDER  @map("compliance-reminder")
  BROADCAST            @map("broadcast")
  OTHER                @map("other")
  @@schema("org")
}

enum NotificationUrgency {
  LOW    @map("low")
  MEDIUM @map("medium")
  HIGH   @map("high")
  URGENT @map("urgent")
  @@schema("org")
}

model NotificationMessage {
  id                 String                 @id @default(uuid()) @db.Uuid
  orgId              String                 @db.Uuid
  userId             String                 @db.Uuid
  title              String
  body               String
  topic              NotificationTopic      @default(OTHER)
  priority           NotificationUrgency    @default(MEDIUM)
  isRead             Boolean                @default(false)
  readAt             DateTime?
  actionUrl          String?
  actionLabel        String?
  scheduledFor       DateTime?
  expiresAt          DateTime?
  retentionPolicyId  String
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  schemaVersion      Int                    @default(1)
  correlationId      String?
  createdByUserId    String?                @db.Uuid
  auditSource        String                 @default("notification-service")
  metadata           Json?                  @db.JsonB
  auditTrail         Json?                  @db.JsonB
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt

  org        Organization @relation("OrgNotificationMessages", fields: [orgId], references: [id], onDelete: Cascade)
  membership Membership   @relation("MembershipNotificationMessages", fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)

  @@index([orgId, userId, isRead])
  @@index([orgId, retentionPolicyId])
  @@index([orgId, dataClassification, residencyTag])
  @@map("notification_messages")
  @@schema("org")
}

// Platform and enterprise admin models extracted for size limits

model PlatformSetting {
  id        String   @id
  branding  Json?    @db.JsonB
  metadata  Json?    @db.JsonB
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
  @@schema("platform")
}

model AppPermission {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String?
  category    String
  isGlobal    Boolean  @default(false)
  metadata    Json?    @db.JsonB
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@map("app_permissions")
  @@schema("platform")
}

model ManagedOrganization {
  id           String   @id @default(uuid()) @db.Uuid
  adminUserId  String   @db.Uuid
  orgId        String   @db.Uuid
  orgName      String
  ownerEmail   String
  planId       String
  moduleAccess Json     @db.JsonB
  metadata     Json?    @db.JsonB
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  admin        User          @relation("ManagedAdmin", fields: [adminUserId], references: [id], onDelete: Cascade)
  organization Organization @relation("ManagedOrgOrganization", fields: [orgId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([orgId])
  @@map("managed_organizations")
  @@schema("org")
}

// Records, documents, auditing models with UK government compliance

enum DocumentType {
  ONBOARDING
  POLICY
  CONTRACT
  EVIDENCE
  TRAINING
  PERFORMANCE
  COMPLIANCE
  MEDICAL
  FINANCIAL
  SECURITY
  OTHER
  @@schema("compliance")
}

enum AuditEventType {
  ACCESS
  DATA_CHANGE
  POLICY_CHANGE
  AUTH
  SYSTEM
  COMPLIANCE
  SECURITY
  DOCUMENT
  LEAVE_REQUEST
  PAYROLL
  @@schema("compliance")
}

enum RetentionPolicy {
  IMMEDIATE
  ONE_YEAR
  THREE_YEARS
  SEVEN_YEARS
  PERMANENT
  LEGAL_HOLD
  @@schema("compliance")
}

enum SecurityClassification {
  UNCLASSIFIED
  OFFICIAL
  OFFICIAL_SENSITIVE
  SECRET
  TOP_SECRET
  @@schema("compliance")
}

model DocumentVault {
  id                String              @id @default(uuid()) @db.Uuid
  orgId             String              @db.Uuid
  ownerOrgId        String?             @db.Uuid
  ownerUserId       String?             @db.Uuid
  type              DocumentType        @default(OTHER)
  classification    SecurityClassification @default(UNCLASSIFIED)
  retentionPolicy   RetentionPolicy     @default(THREE_YEARS)
  retentionExpires  DateTime?           // Calculated based on retention policy
  blobPointer       String
  checksum          String
  mimeType          String?
  sizeBytes         Int?
  fileName          String              // Original filename for audit trail
  version           Int                 @default(1)
  latestVersionId   String?             @db.Uuid // For version chains
  encrypted         Boolean             @default(false) // Field-level encryption
  encryptedKeyRef   String?             // Reference to KMS key
  // UK compliance fields
  sensitivityLevel  Int                 @default(0) // 0-4 scale for sensitivity
  dataCategory      String?             // Personal, financial, health, etc.
  lawfulBasis       String?             // For GDPR compliance
  dataSubject       Json?               @db.JsonB   // For data subject rights
  // Audit trail
  metadata          Json?               @db.JsonB
  createdAt         DateTime            @default(now())

  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  owner       Membership?  @relation("DocumentOwner", fields: [ownerOrgId, ownerUserId], references: [orgId, userId])
  documentTemplateAssignments DocumentTemplateAssignment[]

  @@index([orgId])
  @@index([classification])
  @@index([retentionPolicy, retentionExpires])
  @@map("document_vault")
  @@schema("compliance")
}

model DocumentTemplate {
  id                 String                 @id @default(uuid()) @db.Uuid
  orgId              String                 @db.Uuid
  name               String
  type               DocumentType           @default(OTHER)
  templateBody       String
  templateSchema     Json?                  @db.JsonB
  version            Int                    @default(1)
  isActive           Boolean                @default(true)
  metadata           Json?                  @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignments DocumentTemplateAssignment[]

  @@index([orgId, type, isActive])
  @@map("document_templates")
  @@schema("compliance")
}

model AuditLog {
  id         String         @id @default(uuid()) @db.Uuid
  orgId      String         @db.Uuid
  userId     String?        @db.Uuid
  eventType  AuditEventType
  action     String
  resource   String
  resourceId String?
  ipAddress  String?
  userAgent  String?
  // UK compliance fields
  sessionTokenHash String?  // For audit verification
  securityLevel      Int?   // For security event classification
  // For GDPR compliance
  dataSubjectId String?     // Reference to the data owner
  immutable  Boolean        @default(true)
  deletedAt  DateTime?
  // Payload for audit trail
  payload    Json?          @db.JsonB
  createdAt  DateTime       @default(now())

  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  membership Membership?  @relation(fields: [orgId, userId], references: [orgId, userId])

  @@index([orgId, createdAt])
  @@index([orgId, eventType])
  @@index([dataSubjectId])
  @@map("audit_logs")
  @@schema("compliance")
}

model EventOutbox {
  id          String   @id @default(uuid()) @db.Uuid
  orgId       String   @db.Uuid
  eventType   String
  payload     Json     @db.JsonB
  status      String   @default("pending")
  error       Json?    @db.JsonB
  availableAt DateTime @default(now())
  processedAt DateTime?
  maxRetries  Int      @default(3)
  retryCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([status, availableAt])
  @@index([orgId, eventType])
  @@map("event_outbox")
  @@schema("compliance")
}

// UK-specific compliance model
model ComplianceRecord {
  id               String   @id @default(uuid()) @db.Uuid
  orgId            String   @db.Uuid
  complianceType   String   // e.g., "SAR", "GDPR", "FOI", "DSEAR"
  referenceNumber  String   // For tracking
  status           String   @default("open")
  title            String
  description      String
  assignedToOrgId  String?  @db.Uuid
  assignedToUserId String?  @db.Uuid
  priority         Int      @default(2) // 1-5 scale
  dueDate          DateTime?
  completedAt      DateTime?
  // UK compliance fields
  submittedByOrgId  String?  @db.Uuid
  submittedByUserId String?  @db.Uuid
  submittedAt      DateTime?
  responseDate     DateTime?
  escalationDate   DateTime?
  metadata         Json?    @db.JsonB
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  org    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignee Membership? @relation("ComplianceAssignee", fields: [assignedToOrgId, assignedToUserId], references: [orgId, userId])
  submitter Membership? @relation("ComplianceSubmitter", fields: [submittedByOrgId, submittedByUserId], references: [orgId, userId])

  @@unique([orgId, referenceNumber])
  @@index([orgId, status])
  @@map("records")
  @@schema("compliance")
}

// UK-specific statutory reporting model
model StatutoryReport {
  id               String   @id @default(uuid()) @db.Uuid
  orgId            String   @db.Uuid
  reportType       String   // "PAYE", "NI", "P60", "P11D", "AutoEnrolment", etc.
  period           String   // e.g., "2023-04", "2023-Q1"
  dueDate          DateTime
  submittedAt      DateTime?
  submittedByOrgId  String?  @db.Uuid
  submittedByUserId String?  @db.Uuid
  status           String   @default("pending")
  fileName         String?  // Generated report filename
  fileSize         Int?     // Size in bytes
  checksum         String?  // For data integrity
  metadata         Json?    @db.JsonB
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  org    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  submitter Membership? @relation("ReportSubmitter", fields: [submittedByOrgId, submittedByUserId], references: [orgId, userId])

  @@index([orgId, reportType, period])
  @@index([dueDate])
  @@map("statutory_reports")
  @@schema("compliance")
}

// For GDPR data subject rights
model DataSubjectRight {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @db.Uuid
  userId        String?  @db.Uuid // Nullable for non-user data subjects
  rightType     String   // "access", "rectification", "erasure", "portability", "objection", "restriction"
  status        String   @default("pending")
  requestDate   DateTime @default(now())
  dueDate       DateTime // Deadline based on regulation
  completedAt   DateTime?
  responseDate  DateTime?
  // For non-user data subjects
  dataSubjectInfo Json? @db.JsonB
  response      String?
  responseFrom  String?  @db.Uuid
  notes         String?
  metadata      Json?    @db.JsonB
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  requestor   User?  @relation("DSRRequestor", fields: [userId], references: [id])
  responder   User?  @relation("DSRResponder", fields: [responseFrom], references: [id])

  @@index([orgId, rightType])
  @@index([status])
  @@map("data_subject_rights")
  @@schema("compliance")
}

// Tenant domain models with UK government compliance
enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  DECOMMISSIONED
  @@schema("hr")
}
enum ComplianceTier {
  STANDARD
  REGULATED
  GOV_SECURE
  @@schema("hr")
}
enum DataResidencyZone {
  UK_ONLY
  UK_AND_EEA
  GLOBAL_RESTRICTED
  @@schema("hr")
}
enum DataClassificationLevel {
  OFFICIAL
  OFFICIAL_SENSITIVE
  SECRET
  TOP_SECRET
  @@schema("hr")
}
enum RoleScope {
  ORG
  DEPARTMENT
  GLOBAL
  @@schema("hr")
}
enum MembershipStatus {
  INVITED
  ACTIVE
  SUSPENDED
  DEACTIVATED
  @@schema("hr")
}
enum NotificationChannel {
  EMAIL
  IN_APP
  SMS
  @@schema("hr")
}
model Organization {
  id                   String                  @id @default(uuid()) @db.Uuid
  slug                 String                  @unique @db.Citext
  name                 String
  status               OrganizationStatus      @default(ACTIVE)
  complianceTier       ComplianceTier          @default(STANDARD)
  dataResidency        DataResidencyZone       @default(UK_ONLY)
  dataClassification   DataClassificationLevel @default(OFFICIAL)
  regionCode           String

  // Organization profile + legacy fields (migrated from the old Firebase shape)
  address               String?
  phone                 String?
  website               String?
  companyType           String?
  industry              String?
  employeeCountRange    String?
  incorporationDate     DateTime?
  registeredOfficeAddress String?
  contactDetails        Json?                   @db.JsonB

  // Leave settings legacy columns
  primaryLeaveType      String?
  leaveYearStartDate    DateTime?

  // Admin + subscription legacy fields
  ownerUid              String?                 @db.Uuid
  ownerEmail            String?                 @db.Citext
  ownerName             String?
  subscriptionPlan      String?
  subscriptionStatus    String?
  userCount             Int?
  availablePermissions  Json?                   @db.JsonB

  settings             Json                    @default("{}") @db.JsonB
  governanceTags       Json?                   @db.JsonB
  securityControls     Json?                   @db.JsonB // Security configuration per UK standards
  encryptionKey        String?                 @db.Text // For field-level encryption
  tenantId             String                  // For multi-tenancy isolation
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt

  locations             Location[]
  memberships             Membership[]
  roles                   Role[]
  departments             Department[]
  leavePolicies           LeavePolicy[]
  documents               DocumentVault[]
  auditLogs               AuditLog[]
  notificationPreferences NotificationPreference[]
  integrations            IntegrationConfig[]
  outboxEvents            EventOutbox[]
  invitations             Invitation[]
  securityEvents          SecurityEvent[]
  tenantSecurityEvents    TenantSecurityEvent[] @relation("TenantSecurityEventOrganization")
  globalSecurityEvents    GlobalSecurityEvent[] @relation("GlobalSecurityEventSourceOrg")
  complianceRecords      ComplianceRecord[]
  statutoryReports       StatutoryReport[]
  dataSubjectRights      DataSubjectRight[]
  absenceTypes           AbsenceTypeConfig[]
  absenceSettings        AbsenceSettings?
  unplannedAbsences      UnplannedAbsence[]
  timeEntries            TimeEntry[]
  hrPolicies             HRPolicy[]
  hrNotifications        HRNotification[]
  notificationMessages   NotificationMessage[] @relation("OrgNotificationMessages")
  permissionResources    PermissionResource[]
  hrSettings             HRSettings?
  checklistTemplates     ChecklistTemplate[] @relation("OrgChecklistTemplates")
  checklistInstances     ChecklistInstance[] @relation("OrgChecklistInstances")
  offboardingRecords     Offboarding[]
  mentorAssignments      MentorAssignment[]
  provisioningTasks      ProvisioningTask[]
  onboardingWorkflowTemplates OnboardingWorkflowTemplate[]
  onboardingWorkflowRuns OnboardingWorkflowRun[]
  emailSequenceTemplates EmailSequenceTemplate[]
  emailSequenceEnrollments EmailSequenceEnrollment[]
  emailSequenceDeliveries EmailSequenceDelivery[]
  onboardingMetricDefinitions OnboardingMetricDefinition[]
  onboardingMetricResults OnboardingMetricResult[]
  onboardingFeedback     OnboardingFeedback[]
  documentTemplates      DocumentTemplate[]
  documentTemplateAssignments DocumentTemplateAssignment[]
  complianceTemplates    ComplianceTemplate[] @relation("OrgComplianceTemplates")
  complianceReminderSettings ComplianceReminderSettings?
  complianceCategories   ComplianceCategory[] @relation("OrgComplianceCategories")
  complianceLogItems     ComplianceLogItem[] @relation("OrgComplianceLogItems")
  managedOrganizations   ManagedOrganization[] @relation("ManagedOrgOrganization")
  subscriptions          OrganizationSubscription[]
  paymentMethods         PaymentMethod[]
  billingInvoices        BillingInvoice[]
  @@index([tenantId]) // For tenant isolation
  @@map("organizations") // PostgreSQL schema mapping
  @@schema("hr")
}

model Location {
  id        String   @id @db.Uuid
  orgId     String   @db.Uuid
  name      String
  address   String
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("locations")
  @@schema("hr")
}
model User {
  id               String           @id @default(uuid()) @db.Uuid
  email            String           @unique @db.Citext
  displayName      String?
  status           MembershipStatus @default(INVITED)
  authProvider     String           @default("better-auth")
  lastLoginAt      DateTime?
  failedLoginCount Int              @default(0) // For security monitoring
  lockedUntil      DateTime?        // Account lockout for security
  lastPasswordChange DateTime       @default(now()) // For password policy compliance
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  memberships         Membership[]
  invitationsSent     Invitation[] @relation("InvitationInvitedBy")
  invitationsAccepted Invitation[] @relation("InvitationAcceptedBy")
  invitationsRevoked  Invitation[] @relation("InvitationRevokedBy")
  securityEvents      SecurityEvent[]
  resolvedSecurityEvents SecurityEvent[] @relation("SecurityEventResolver")
  tenantSecurityEvents TenantSecurityEvent[] @relation("TenantSecurityEventUser")
  resolvedTenantSecurityEvents TenantSecurityEvent[] @relation("TenantSecurityEventResolver")
  globalSecurityEvents GlobalSecurityEvent[] @relation("GlobalSecurityEventUser")
  resolvedGlobalSecurityEvents GlobalSecurityEvent[] @relation("GlobalSecurityEventResolver")
  sessions            UserSession[]
  // submitter relationships are modelled as Membership -> ComplianceRecord/StatutoryReport
  dsrRequests          DataSubjectRight[] @relation("DSRRequestor")
  dsrResponses         DataSubjectRight[] @relation("DSRResponder")
  managedOrganizations ManagedOrganization[] @relation("ManagedAdmin")
  @@index([email])
  @@schema("hr")
}
model Role {
  id          String    @id @default(uuid()) @db.Uuid
  orgId       String    @db.Uuid
  name        String
  description String?
  scope       RoleScope @default(ORG)
  permissions Json      @default("{}") @db.JsonB
  inheritsRoleIds String[] @default([]) @db.Text
  isSystem    Boolean   @default(false)
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  memberships Membership[]
  @@unique([orgId, name])
  @@map("roles")
  @@schema("hr")
}
model PermissionResource {
  id          String   @id @default(uuid()) @db.Uuid
  orgId       String   @db.Uuid
  resource    String
  actions     String[] @db.Text
  description String?
  metadata    Json?    @db.JsonB
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, resource])
  @@index([orgId])
  @@map("permission_resources")
  @@schema("hr")
}
model Department {
  id           String   @id @default(uuid()) @db.Uuid
  orgId        String   @db.Uuid
  name         String
  path         String?  // For hierarchical department structures
  leaderOrgId  String?  @db.Uuid
  leaderUserId String?  @db.Uuid
  businessUnit String?  // For organizational hierarchy
  costCenter   String?  // For financial tracking
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  org           Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  leader        Membership?   @relation("DepartmentLead", fields: [leaderOrgId, leaderUserId], references: [orgId, userId])
  memberships   Membership[]
  leavePolicies LeavePolicy[]
  employmentContracts EmploymentContract[]
  employeeProfiles EmployeeProfile[] @relation("DepartmentProfiles")
  @@unique([orgId, name])
  @@map("departments")
  @@schema("hr")
}
model Membership {
  orgId         String           @db.Uuid
  userId        String           @db.Uuid
  roleId        String?          @db.Uuid
  departmentId  String?          @db.Uuid
  status        MembershipStatus @default(INVITED)
  invitedBy     String?          @db.Uuid
  invitedAt     DateTime?
  activatedAt   DateTime?
  deactivatedAt DateTime?
  lastAccessedAt DateTime?        // For access compliance tracking
  metadata      Json?            @db.JsonB
  // Required for UK compliance audit trails
  createdBy     String           @db.Uuid
  updatedBy     String?          @db.Uuid
  org                     Organization             @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user                    User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role                    Role?                    @relation(fields: [roleId], references: [id], onDelete: SetNull)
  department              Department?              @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  profile                 EmployeeProfile?
  balances                LeaveBalance[]           @relation("MembershipLeaveBalances")
  leaveRequests           LeaveRequest[]
  auditLogs               AuditLog[]
  ledDepartments          Department[]             @relation("DepartmentLead")
  leaveApprovals          LeaveRequest[]           @relation("LeaveApprover")
  documentsOwned          DocumentVault[]          @relation("DocumentOwner")
  notificationPreferences NotificationPreference[]
  employmentContracts     EmploymentContract[]
  reviewsAsReviewee       PerformanceReview[] @relation("RevieweeMembership")
  reviewsAsReviewer      PerformanceReview[] @relation("ReviewerMembership")
  trainingRecords        TrainingRecord[]
  reportedAbsences       UnplannedAbsence[] @relation("MemberAbsences")
  approvedAbsences       UnplannedAbsence[] @relation("AbsenceApprover")
  timeEntries            TimeEntry[] @relation("MemberTimeEntries")
  approvedTimeEntries    TimeEntry[] @relation("TimeEntryApprover")
  policyAcknowledgments  PolicyAcknowledgment[]
  notifications          HRNotification[]
  notificationMessages   NotificationMessage[] @relation("MembershipNotificationMessages")
  assignedComplianceRecords ComplianceRecord[] @relation("ComplianceAssignee")
  submittedComplianceRecords  ComplianceRecord[] @relation("ComplianceSubmitter")
  submittedStatutoryReports   StatutoryReport[]  @relation("ReportSubmitter")
  complianceLogItems     ComplianceLogItem[] @relation("MembershipComplianceLogItems")
  mentorAssignments      MentorAssignment[] @relation("MentorAssignmentMentor")
  provisioningRequests   ProvisioningTask[] @relation("ProvisioningRequester")
  @@id([orgId, userId])
  @@index([userId])
  @@index([orgId, status])
  @@map("memberships")
  @@schema("hr")
}
model NotificationPreference {
  id         String              @id @default(uuid()) @db.Uuid
  orgId      String              @db.Uuid
  userId     String              @db.Uuid
  channel    NotificationChannel
  enabled    Boolean             @default(true)
  quietHours Json?               @db.JsonB
  metadata   Json?               @db.JsonB
  updatedAt  DateTime            @updatedAt
  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  membership Membership   @relation(fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)
  @@unique([orgId, userId, channel])
  @@map("notification_preferences")
  @@schema("hr")
}
model IntegrationConfig {
  id          String   @id @default(uuid()) @db.Uuid
  orgId       String   @db.Uuid
  provider    String
  credentials Json     @db.JsonB // Encrypted at application layer
  settings    Json     @db.JsonB
  active      Boolean  @default(true)
  compliance  Json?    @db.JsonB // Integration compliance settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  @@unique([orgId, provider])
  @@map("integration_configs")
  @@schema("hr")
}
