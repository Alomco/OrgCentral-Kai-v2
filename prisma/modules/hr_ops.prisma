// HR operational models: absences, time tracking, policies, settings, compliance

enum AbsenceStatus {
  REPORTED
  APPROVED
  REJECTED
  CANCELLED
  CLOSED
  @@schema("hr")
}

enum TimeEntryStatus {
  ACTIVE
  COMPLETED
  APPROVED
  REJECTED
  @@schema("hr")
}

enum PolicyCategory {
  HR_POLICIES
  CODE_OF_CONDUCT
  HEALTH_SAFETY
  IT_SECURITY
  BENEFITS
  PROCEDURES
  COMPLIANCE
  OTHER
  @@schema("hr")
}

enum ChecklistTemplateType {
  onboarding
  offboarding
  custom
  @@schema("hr")
}

enum ChecklistInstanceStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
  @@schema("hr")
}

enum ComplianceItemStatus {
  PENDING
  COMPLETE
  MISSING
  PENDING_REVIEW
  NOT_APPLICABLE
  EXPIRED
  @@schema("hr")
}

model AbsenceTypeConfig {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @db.Uuid
  key           String
  label         String
  tracksBalance Boolean  @default(false)
  isActive      Boolean  @default(true)
  metadata      Json?    @db.JsonB
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  org       Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  absences  UnplannedAbsence[]

  @@unique([orgId, key])
  @@map("absence_type_configs")
  @@schema("hr")
}

model AbsenceSettings {
  orgId          String   @id @db.Uuid
  hoursInWorkDay Decimal  @db.Decimal(5, 2) @default(8)
  roundingRule   String?
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("absence_settings")
  @@schema("hr")
}

model HRSettings {
  orgId             String   @id @db.Uuid
  leaveTypes        Json?    @db.JsonB // Array of { type, displayName, entitlement, maxCarryOver, requiresApproval, autoApprovalThreshold }
  workingHours      Json?    @db.JsonB // { standardHoursPerDay, standardDaysPerWeek, overtimeThreshold }
  approvalWorkflows Json?    @db.JsonB // { leaveRequests: {...}, documents: {...}, policies: {...} }
  overtimePolicy    Json?    @db.JsonB // { enableOvertime, roundingRule, approvalRequired }
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  metadata          Json?    @db.JsonB
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("hr_settings")
  @@schema("hr")
}

model UnplannedAbsence {
  id             String         @id @default(uuid()) @db.Uuid
  orgId          String         @db.Uuid
  userId         String         @db.Uuid
  typeId         String         @db.Uuid
  startDate      DateTime
  endDate        DateTime
  hours          Decimal        @db.Decimal(6, 2)
  reason         String?
  status         AbsenceStatus  @default(REPORTED)
  healthStatus   HealthStatus?
  approverOrgId  String?        @db.Uuid
  approverUserId String?        @db.Uuid
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  metadata       Json?          @db.JsonB
  deletionReason String?
  deletedAt      DateTime?
  deletedByUserId String?       @db.Uuid
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  org      Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  member   Membership        @relation("MemberAbsences", fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)
  type     AbsenceTypeConfig @relation(fields: [typeId], references: [id], onDelete: Restrict)
  approver Membership?       @relation("AbsenceApprover", fields: [approverOrgId, approverUserId], references: [orgId, userId], onDelete: SetNull)
  attachments   AbsenceAttachment[]
  returnRecord  AbsenceReturnRecord?
  deletionAudit AbsenceDeletionAudit?

  @@index([orgId, userId])
  @@index([orgId, status])
  @@map("unplanned_absences")
  @@schema("hr")
}

model AbsenceAttachment {
  id               String                 @id @default(uuid()) @db.Uuid
  orgId            String                 @db.Uuid
  absenceId        String                 @db.Uuid
  fileName         String
  storageKey       String
  contentType      String
  fileSize         Int
  checksum         String?
  uploadedByUserId String                 @db.Uuid
  uploadedAt       DateTime               @default(now())
  metadata         Json?                  @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)

  absence  UnplannedAbsence @relation(fields: [absenceId], references: [id], onDelete: Cascade)
  @@index([orgId, absenceId])
  @@map("unplanned_absence_attachments")
  @@schema("hr")
}

model AbsenceReturnRecord {
  id                String                 @id @default(uuid()) @db.Uuid
  orgId             String                 @db.Uuid
  absenceId         String                 @db.Uuid @unique
  returnDate        DateTime
  comments          String?
  submittedByUserId String                 @db.Uuid
  submittedAt       DateTime               @default(now())
  metadata          Json?                  @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)

  absence  UnplannedAbsence @relation(fields: [absenceId], references: [id], onDelete: Cascade)
  @@index([orgId])
  @@map("unplanned_absence_returns")
  @@schema("hr")
}

model AbsenceDeletionAudit {
  id               String                 @id @default(uuid()) @db.Uuid
  orgId            String                 @db.Uuid
  absenceId        String                 @db.Uuid @unique
  reason           String
  deletedByUserId  String                 @db.Uuid
  deletedAt        DateTime               @default(now())
  metadata         Json?                  @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)

  absence   UnplannedAbsence @relation(fields: [absenceId], references: [id], onDelete: Cascade)
  @@index([orgId])
  @@map("unplanned_absence_deletions")
  @@schema("hr")
}

model TimeEntry {
  id               String          @id @default(uuid()) @db.Uuid
  orgId            String          @db.Uuid
  userId           String          @db.Uuid
  date             DateTime
  clockIn          DateTime
  clockOut         DateTime?
  totalHours       Decimal?        @db.Decimal(6, 2)
  breakDuration    Decimal?        @db.Decimal(5, 2)
  project          String?
  tasks            Json?           @db.JsonB
  notes            String?
  status           TimeEntryStatus @default(ACTIVE)
  approvedByOrgId  String?         @db.Uuid
  approvedByUserId String?         @db.Uuid
  approvedAt       DateTime?
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  metadata         Json?           @db.JsonB
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  org        Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  membership Membership      @relation("MemberTimeEntries", fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)
  approver   Membership?     @relation("TimeEntryApprover", fields: [approvedByOrgId, approvedByUserId], references: [orgId, userId], onDelete: SetNull)

  @@index([orgId, userId])
  @@index([orgId, status])
  @@map("time_entries")
  @@schema("hr")
}

model HRPolicy {
  id                     String          @id @default(uuid()) @db.Uuid
  orgId                  String          @db.Uuid
  title                  String
  content                String
  category               PolicyCategory  @default(HR_POLICIES)
  version                String          @default("v1")
  effectiveDate          DateTime
  expiryDate             DateTime?
  applicableRoles        Json?           @db.JsonB
  applicableDepartments  Json?           @db.JsonB
  requiresAcknowledgment Boolean         @default(false)
  status                 String          @default("draft")
  dataClassification     DataClassificationLevel @default(OFFICIAL)
  residencyTag           DataResidencyZone       @default(UK_ONLY)
  metadata               Json?           @db.JsonB
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  org             Organization          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  acknowledgments PolicyAcknowledgment[]

  @@index([orgId, status])
  @@map("policies")
  @@schema("hr")
}

model PolicyAcknowledgment {
  id             String   @id @default(uuid()) @db.Uuid
  orgId          String   @db.Uuid
  userId         String   @db.Uuid
  policyId       String   @db.Uuid
  version        String
  acknowledgedAt DateTime @default(now())
  ipAddress      String?
  metadata       Json?    @db.JsonB

  policy     HRPolicy    @relation(fields: [policyId], references: [id], onDelete: Cascade)
  membership Membership  @relation(fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)

  @@unique([policyId, orgId, userId, version])
  @@map("policy_acknowledgments")
  @@schema("hr")
}

model ChecklistTemplate {
  id        String                @id @default(uuid()) @db.Uuid
  orgId     String                @db.Uuid
  name      String
  type      ChecklistTemplateType @default(onboarding)
  items     Json                  @db.JsonB
  metadata  Json?                 @db.JsonB
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  org Organization @relation("OrgChecklistTemplates", fields: [orgId], references: [id], onDelete: Cascade)
  instances ChecklistInstance[] @relation("ChecklistTemplateInstances")

  @@index([orgId, type])
  @@map("checklist_templates")
  @@schema("hr")
}

model ChecklistInstance {
  id           String                   @id @default(uuid()) @db.Uuid
  orgId        String                   @db.Uuid
  employeeId   String                   @db.Uuid
  templateId   String                   @db.Uuid
  templateName String?
  status       ChecklistInstanceStatus  @default(IN_PROGRESS)
  items        Json                     @db.JsonB
  startedAt    DateTime                 @default(now())
  completedAt  DateTime?
  metadata     Json?                    @db.JsonB
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt

  org      Organization       @relation("OrgChecklistInstances", fields: [orgId], references: [id], onDelete: Cascade)
  template ChecklistTemplate  @relation("ChecklistTemplateInstances", fields: [templateId], references: [id], onDelete: Cascade)
  employee EmployeeProfile    @relation("EmployeeChecklistInstances", fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([orgId, employeeId])
  @@index([templateId])
  @@map("checklist_instances")
  @@schema("hr")
}

model ComplianceTemplate {
  id          String   @id @default(uuid()) @db.Uuid
  orgId       String   @db.Uuid
  name        String
  categoryKey String?
  version     String?
  items       Json     @db.JsonB
  metadata    Json?    @db.JsonB
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  org Organization @relation("OrgComplianceTemplates", fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, categoryKey])
  @@map("compliance_templates")
  @@schema("hr")
}

model ComplianceCategory {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @db.Uuid
  key       String
  label     String
  sortOrder Int      @default(100)
  metadata  Json?    @db.JsonB
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org Organization @relation("OrgComplianceCategories", fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, key])
  @@index([orgId, sortOrder])
  @@map("compliance_categories")
  @@schema("hr")
}

model ComplianceLogItem {
  id            String                @id @default(uuid()) @db.Uuid
  orgId         String                @db.Uuid
  userId        String                @db.Uuid
  templateItemId String
  categoryKey   String?
  status        ComplianceItemStatus  @default(PENDING)
  dueDate       DateTime?
  completedAt   DateTime?
  reviewedBy    String?
  reviewedAt    DateTime?
  notes         String?
  attachments   Json?                 @db.JsonB
  metadata      Json?                 @db.JsonB
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  org        Organization @relation("OrgComplianceLogItems", fields: [orgId], references: [id], onDelete: Cascade)
  membership Membership   @relation("MembershipComplianceLogItems", fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)

  @@index([orgId, userId])
  @@index([status, dueDate])
  @@map("compliance_log_items")
  @@schema("hr")
}
