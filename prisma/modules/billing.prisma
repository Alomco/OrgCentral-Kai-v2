// Billing and subscription models
enum BillingSubscriptionStatus {
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  PAUSED
  @@schema("hr")
}

model OrganizationSubscription {
  id                       String                    @id @default(uuid()) @db.Uuid
  orgId                    String                    @db.Uuid
  stripeCustomerId         String                    @db.Text
  stripeSubscriptionId     String                    @db.Text
  stripeSubscriptionItemId String?                   @db.Text
  stripePriceId            String                    @db.Text
  status                   BillingSubscriptionStatus @default(INCOMPLETE)
  seatCount                Int                       @default(1)
  currentPeriodEnd         DateTime?
  cancelAtPeriodEnd        Boolean                   @default(false)
  lastStripeEventAt        DateTime?
  metadata                 Json?                     @db.JsonB
  dataClassification       DataClassificationLevel   @default(OFFICIAL)
  residencyTag             DataResidencyZone         @default(UK_ONLY)
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId])
  @@unique([stripeCustomerId])
  @@unique([stripeSubscriptionId])
  @@index([orgId, status])
  @@map("organization_subscriptions")
  @@schema("hr")
}

enum PaymentMethodType {
  CARD
  BACS_DEBIT
  SEPA_DEBIT
  @@schema("hr")
}

model PaymentMethod {
  id                     String                @id @default(uuid()) @db.Uuid
  orgId                  String                @db.Uuid
  stripePaymentMethodId  String                @unique @db.Text
  type                   PaymentMethodType
  last4                  String
  brand                  String?               @db.Text
  bankName               String?               @db.Text
  expiryMonth            Int?
  expiryYear             Int?
  isDefault              Boolean               @default(false)
  metadata               Json?                 @db.JsonB
  dataClassification     DataClassificationLevel @default(OFFICIAL)
  residencyTag           DataResidencyZone       @default(UK_ONLY)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([orgId, isDefault])
  @@map("payment_methods")
  @@schema("hr")
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
  @@schema("hr")
}

model BillingInvoice {
  id                String                @id @default(uuid()) @db.Uuid
  orgId             String                @db.Uuid
  stripeInvoiceId   String                @unique @db.Text
  status            InvoiceStatus
  amountDue         Int
  amountPaid        Int
  currency          String                @default("gbp")
  periodStart       DateTime
  periodEnd         DateTime
  userCount         Int
  invoiceUrl        String?               @db.Text
  invoicePdf        String?               @db.Text
  paidAt            DateTime?
  metadata          Json?                 @db.JsonB
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, periodStart])
  @@index([orgId, status])
  @@map("billing_invoices")
  @@schema("hr")
}
