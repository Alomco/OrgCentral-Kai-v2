// HR domain models with UK employment law compliance

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  INTERN
  APPRENTICE
  FIXED_TERM
  CASUAL
  @@schema("hr")
}

enum LeavePolicyType {
  ANNUAL
  SICK
  MATERNITY
  PATERNITY
  ADOPTION
  UNPAID
  SPECIAL
  EMERGENCY
  @@schema("hr")
}

enum LeaveAccrualFrequency {
  MONTHLY
  QUARTERLY
  YEARLY
  NONE
  @@schema("hr")
}

enum LeaveRequestStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
  PENDING_APPROVAL
  AWAITING_MANAGER
  @@schema("hr")
}

enum HealthStatus {
  UNDEFINED
  FIT_FOR_WORK
  PARTIALLY_FIT
  UNFIT_FOR_WORK
  RECOVERY_PLAN
  @@schema("hr")
}

enum EmploymentStatus {
  ACTIVE
  INACTIVE
  TERMINATED
  ON_LEAVE
  OFFBOARDING
  ARCHIVED
  @@schema("hr")
}

enum SalaryFrequency {
  HOURLY
  MONTHLY
  ANNUALLY
  @@schema("hr")
}

enum SalaryBasis {
  ANNUAL
  HOURLY
  @@schema("hr")
}

enum PaySchedule {
  MONTHLY
  BI_WEEKLY
  @@schema("hr")
}

enum ContractType {
  PERMANENT
  FIXED_TERM
  AGENCY
  CONSULTANT
  INTERNSHIP
  APPRENTICESHIP
  @@schema("hr")
}

enum PerformanceGoalStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  @@schema("hr")
}

model EmployeeProfile {
  id               String           @id @default(uuid()) @db.Uuid
  orgId            String           @db.Uuid
  userId           String           @db.Uuid
  firstName        String?
  lastName         String?
  displayName      String?
  photoUrl         String?
  email            String?          @db.Citext
  personalEmail    String?          @db.Citext
  employeeNumber   String
  jobTitle         String?
  departmentId     String?          @db.Uuid
  employmentType   EmploymentType   @default(FULL_TIME)
  employmentStatus EmploymentStatus @default(ACTIVE)
  startDate        DateTime?
  endDate          DateTime?
  managerOrgId     String?          @db.Uuid
  managerUserId    String?          @db.Uuid
  phone            Json?            @db.JsonB
  address          Json?            @db.JsonB
  annualSalary     Int?
  hourlyRate       Decimal?         @db.Decimal(8, 2) // For part-time/contract workers
  salaryAmount     Decimal?         @db.Decimal(12, 2)
  salaryCurrency   String?
  salaryFrequency  SalaryFrequency?
  salaryBasis      SalaryBasis?
  paySchedule      PaySchedule?
  costCenter       String?
  location         Json?            @db.JsonB
  roles            String[]         @db.Text
  eligibleLeaveTypes String[]       @db.Text
  employmentPeriods Json?           @db.JsonB
  salaryDetails    Json?            @db.JsonB
  skills           String[]         @db.Text
  certifications   Json?            @db.JsonB
  // UK-specific fields
  niNumber         String?          @db.Text // National Insurance number (encrypted at app layer)
  emergencyContact Json?            @db.JsonB
  nextOfKin        Json?            @db.JsonB
  healthStatus     HealthStatus     @default(UNDEFINED)
  workPermit       Json?            @db.JsonB // For visa/immigration compliance
  bankDetails      Json?            @db.JsonB // Encrypted at application layer
  metadata         Json?            @db.JsonB
  // Compliance, audit, retention
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource      String?
  correlationId    String?
  schemaVersion    Int              @default(1)
  createdBy        String?          @db.Uuid
  updatedBy        String?          @db.Uuid
  retentionPolicy  RetentionPolicy?
  retentionExpiresAt DateTime?
  erasureRequestedAt DateTime?
  erasureCompletedAt DateTime?
  erasureReason    String?
  erasureActorOrgId String?         @db.Uuid
  erasureActorUserId String?        @db.Uuid
  archivedAt       DateTime?
  deletedAt        DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  membership    Membership        @relation(fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)
  manager       EmployeeProfile?  @relation("EmployeeManager", fields: [managerOrgId, managerUserId], references: [orgId, userId])
  reports       EmployeeProfile[] @relation("EmployeeManager")
  leaveBalances LeaveBalance[]    @relation("ProfileLeaveBalances")
  checklistInstances ChecklistInstance[] @relation("EmployeeChecklistInstances")
  department    Department?       @relation("DepartmentProfiles", fields: [departmentId], references: [id], onDelete: SetNull)

  @@unique([orgId, userId])
  @@unique([orgId, employeeNumber])
  @@index([orgId, email])
  @@index([managerOrgId, managerUserId])
  @@index([orgId, employmentStatus])
  @@index([orgId, dataClassification, residencyTag])
  @@index([departmentId])
  @@map("employee_profiles")
  @@schema("hr")
}

model EmploymentContract {
  id               String        @id @default(uuid()) @db.Uuid
  orgId            String        @db.Uuid
  userId           String        @db.Uuid
  contractType     ContractType  @default(PERMANENT)
  startDate        DateTime
  endDate          DateTime?
  jobTitle         String
  departmentId     String?       @db.Uuid
  location         String?
  probationEndDate DateTime?
  // UK-specific fields
  furloughStartDate DateTime?    // For UK furlough schemes
  furloughEndDate   DateTime?
  workingPattern    Json?        @db.JsonB // Hours, flexible work arrangements
  benefits          Json?        @db.JsonB
  terminationReason String?
  terminationNotes  String?
  archivedAt        DateTime?
  deletedAt        DateTime?
  // Compliance, audit, retention
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource      String?
  correlationId    String?
  schemaVersion    Int              @default(1)
  createdBy        String?          @db.Uuid
  updatedBy        String?          @db.Uuid
  retentionPolicy  RetentionPolicy?
  retentionExpiresAt DateTime?
  erasureRequestedAt DateTime?
  erasureCompletedAt DateTime?
  erasureReason    String?
  erasureActorOrgId String?         @db.Uuid
  erasureActorUserId String?        @db.Uuid
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  membership  Membership     @relation(fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)
  department  Department?    @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  @@index([orgId, userId])
  @@index([orgId, dataClassification, residencyTag])
  @@map("employment_contracts")
  @@schema("hr")
}

model LeavePolicy {
  id               String                @id @default(uuid()) @db.Uuid
  orgId            String                @db.Uuid
  departmentId     String?               @db.Uuid
  name             String
  policyType       LeavePolicyType
  accrualFrequency LeaveAccrualFrequency @default(NONE)
  accrualAmount    Decimal?              @db.Decimal(5, 2)
  carryOverLimit   Int?
  requiresApproval Boolean               @default(true)
  isDefault        Boolean               @default(false)
  activeFrom       DateTime              @default(now())
  activeTo         DateTime?
  // UK-specific compliance fields
  statutoryCompliance Boolean             @default(false) // For statutory leave (sick, maternity, etc.)
  maxConsecutiveDays Int?                 // For policy enforcement
  allowNegativeBalance Boolean           @default(false) // For emergency leave
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource      String?
  auditBatchId     String?
  metadata         Json?                 @db.JsonB

  org          Organization         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  department   Department?          @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  accrualRules LeavePolicyAccrual[]
  balances     LeaveBalance[]
  requests     LeaveRequest[]

  @@unique([orgId, name])
  @@index([orgId, dataClassification, residencyTag])
  @@map("leave_policies")
  @@schema("hr")
}

model LeavePolicyAccrual {
  id               String  @id @default(uuid()) @db.Uuid
  policyId         String  @db.Uuid
  tenureMonths     Int     @default(0)
  accrualPerPeriod Decimal @db.Decimal(5, 2)
  carryOverLimit   Int?

  policy LeavePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([policyId, tenureMonths])
  @@map("leave_policy_accruals")
  @@schema("hr")
}

model LeaveBalance {
  id           String   @id @default(uuid()) @db.Uuid
  orgId        String   @db.Uuid
  userId       String   @db.Uuid
  policyId     String   @db.Uuid
  periodStart  DateTime
  periodEnd    DateTime
  accruedHours Decimal  @db.Decimal(6, 2) @default(0)
  usedHours    Decimal  @db.Decimal(6, 2) @default(0)
  carriedHours Decimal  @db.Decimal(6, 2) @default(0)
  // For UK compliance tracking
  approvedAt   DateTime? // When the balance was last approved
  approvedBy   String?   @db.Uuid
  // For audit trail
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource      String?
  auditBatchId     String?
  metadata     Json?    @db.JsonB
  updatedAt    DateTime @updatedAt

  membership Membership      @relation("MembershipLeaveBalances", fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade, map: "leave_balance_membership_fk")
  profile    EmployeeProfile @relation("ProfileLeaveBalances", fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade, map: "leave_balance_profile_fk")
  policy     LeavePolicy     @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId, policyId, periodStart])
  @@index([policyId])
  @@index([orgId, dataClassification, residencyTag])
  @@map("leave_balances")
  @@schema("hr")
}

model LeaveRequest {
  id             String             @id @default(uuid()) @db.Uuid
  orgId          String             @db.Uuid
  userId         String             @db.Uuid
  policyId       String             @db.Uuid
  status         LeaveRequestStatus @default(DRAFT)
  startDate      DateTime
  endDate        DateTime
  hours          Decimal            @db.Decimal(6, 2)
  reason         String?
  approverOrgId  String?            @db.Uuid
  approverUserId String?            @db.Uuid
  submittedAt    DateTime?
  decidedAt      DateTime?
  // UK-specific fields
  approvedByLineManager Boolean @default(false) // For statutory requirements
  sickNoteRequired  Boolean   @default(false) // For sick leave
  sickNoteReceived  Boolean   @default(false)
  returnToWorkDate  DateTime? // For health monitoring
  // For audit trail
  dataClassification DataClassificationLevel @default(OFFICIAL)
  residencyTag       DataResidencyZone       @default(UK_ONLY)
  auditSource      String?
  auditBatchId     String?
  metadata       Json?              @db.JsonB
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  membership Membership  @relation(fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)
  policy     LeavePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  approver   Membership? @relation("LeaveApprover", fields: [approverOrgId, approverUserId], references: [orgId, userId], onDelete: SetNull)

  @@index([orgId, status])
  @@index([policyId])
  @@index([orgId, dataClassification, residencyTag])
  @@map("leave_requests")
  @@schema("hr")
}

// UK-specific performance and appraisal model
model PerformanceReview {
  id               String   @id @default(uuid()) @db.Uuid
  orgId            String   @db.Uuid
  userId           String   @db.Uuid
  reviewerOrgId    String   @db.Uuid
  reviewerUserId   String   @db.Uuid
  periodStartDate  DateTime
  periodEndDate    DateTime
  scheduledDate    DateTime
  completedDate    DateTime?
  status           String   @default("scheduled")
  overallRating    Int?     // 1-5 scale
  strengths        String?
  areasForImprovement String?
  developmentPlan  Json?    @db.JsonB
  reviewerNotes    String?
  employeeResponse String?
  metadata         Json?    @db.JsonB
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  goals PerformanceGoal[]

  reviewedMembership   Membership @relation("RevieweeMembership", fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)
  reviewerMembership   Membership @relation("ReviewerMembership", fields: [reviewerOrgId, reviewerUserId], references: [orgId, userId], onDelete: Cascade)

  @@index([orgId, userId])
  @@index([periodStartDate])
  @@index([periodEndDate])
  @@map("performance_reviews")
  @@schema("hr")
}

model PerformanceGoal {
  id          String                @id @default(uuid()) @db.Uuid
  orgId       String                @db.Uuid
  reviewId    String                @db.Uuid
  description String
  targetDate  DateTime
  status      PerformanceGoalStatus @default(PENDING)
  rating      Int?
  comments    String?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  review PerformanceReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([orgId, status, targetDate])
  @@index([reviewId])
  @@map("performance_goals")
  @@schema("hr")
}

// UK-specific training and development model
model TrainingRecord {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @db.Uuid
  userId        String   @db.Uuid
  courseName    String
  provider      String
  startDate     DateTime
  endDate       DateTime?
  expiryDate    DateTime?
  renewalDate   DateTime?
  status        String   @default("in_progress")
  certificate   String?  // Path to certificate document
  competency    Json?    @db.JsonB // Skills gained
  cost          Decimal? @db.Decimal(10, 2)
  approved      Boolean  @default(false)
  approvedAt    DateTime?
  approvedBy    String?  @db.Uuid
  metadata      Json?    @db.JsonB
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  membership    Membership @relation(fields: [orgId, userId], references: [orgId, userId], onDelete: Cascade)

  @@index([orgId, userId])
  @@map("training_records")
  @@schema("hr")
}
